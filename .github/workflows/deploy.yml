name: CI/CD Pipeline for Static Site

on:
  push:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🧱 Build site
        run: |
          echo "Building site..."
          mkdir -p dist
          rsync -av --exclude dist . dist/
          echo "Build completed."

      - name: ✅ Run basic HTML test..
        run: |
          echo "Running tests..."
          grep -q "<h1>" index.html && echo "✅ HTML Test Passed" || (echo "❌ Test Failed" && exit 1)

      - name: 🐛 Debug: Show VM secrets (safe)
        run: |
          echo "VM_USER and VM_IP loaded"
        env:
          VM_USER: ${{ secrets.VM_USER }}
          VM_IP: ${{ secrets.VM_IP }}

      - name: 🧰 Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: 🚀 Deploy to Azure VM via SCP
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          VM_USER: ${{ secrets.VM_USER }}
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          echo "Deploying to $VM_USER@$VM_IP..."
          sshpass -p "$VM_PASSWORD" scp -o StrictHostKeyChecking=no -r dist/* "$VM_USER@$VM_IP:/var/www/html/"
